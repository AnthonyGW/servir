#!/usr/bin/env node

const http = require("http");
const app = require("../lib/server");
const parseCommandArgs = require("minimist");
const commandLineUsage = require("command-line-usage");
const sections = require("../lib/help");

const defaultOptions = {
  port: Number(process.env.PORT) || 4040,
  public: process.env.PUBLIC_DIR || ".",
  logstash: process.env.ENABLE_LOGSTASH || false,
  rotate: process.env.ROTATE_LOGS || true,
  logsDir: process.env.LOGS_DIR || "logs",
  app: process.env.APP_NAME || "combined",
  secure: process.env.HTTPS
};

const args = parseCommandArgs(process.argv.slice(2));

if (args.v || args.version) {
  console.log("Serve static version: ", require("../package.json").version);
  process.exit(0);
}
if (args.h || args.help) {
  const usage = commandLineUsage(sections);
  console.log(usage);
  process.exit(0);
}

args.public = args._[0] ? args._[0] : defaultOptions.public;

const options = Object.assign({}, defaultOptions, args);

const port = Number(options.port);

const server = http.createServer(app(options));

const startServer = port => {
  return server.listen(port, error => {
    if (error) throw error;
    console.log(
      `Serving content from ${args.public} directory on port ${port}`
    );
  });
};

startServer(port);
